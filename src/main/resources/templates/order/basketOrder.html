<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Order Page</title>
     <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script>
        var IMP = window.IMP; 
        IMP.init("imp12332144");

        // 함수를 수정하여 각 상품의 가격과 수량을 기반으로 총 금액을 계산
        function calculateTotalAmount() {
            var totalAmount = 0;
            // 상품 정보를 반복하여 가격을 계산
            $('[name^="quantity_"]').each(function() {
                var productId = $(this).attr('name').split('_')[1];
                var quantity = parseInt($(this).val());
                var price = parseInt($('#price_' + productId).text());
                totalAmount += quantity * price;
            });
            return totalAmount;
        }

        function requestPay(event) {
            event.preventDefault();
            var totalAmount = calculateTotalAmount(); // 총액 계산

            IMP.request_pay({
                pg : '9810030929',
                pay_method : 'card',
                merchant_uid: new Date().getTime(), // 상점에서 생성한 고유 주문번호
                name : '주문명:결제테스트',
                amount : 100, // 계산된 총 금액 사용
                buyer_email : 'iamport@siot.do',
                buyer_name : '구매자이름',
                buyer_tel : '010-1234-5678',
                buyer_addr : '서울특별시 강남구 삼성동',
                buyer_postcode : '123-456',
                m_redirect_url : '{결제 완료 후 리디렉션 될 URL}'
            }, function (rsp) { // callback
                if (rsp.success) {
                	var form = document.getElementById("orderForm");
                    form.submit();
                } else {
                    console.log(rsp);
                }
            });
        }
    </script>
</head>
<body>
    <h1>Order Page</h1>

    <!-- Display product information -->
    <h2>Product Information</h2>
    <div th:each="product : ${productsMap}">
        <p>
            Product Name: <span th:text="${product.value.productName}"></span>
        </p>
        <p>
            Price: <span th:text="${product.value.price}" id="price_${product.key}"></span>
        </p>
    </div>

    <!-- Order form -->
    <h2>Order Form</h2>
    <form id="orderForm" th:action="@{/basketOrder}" method="post" onsubmit="requestPay(event)">
        <input type="hidden" name="basketId" th:value="${basketId}" />
        <div th:each="product : ${productsMap}">
            <input type="hidden" th:name="'quantity_' + ${product.key}" th:value="${product.value.quantity}" />
        </div>
        <button type="submit">Order</button>
    </form>
</body>
</html>