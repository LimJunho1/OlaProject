<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link href="/css/main.css" rel="stylesheet" />
<link href="/css/mypage.css" rel="stylesheet" />
<title>Basket List</title>
<!-- jQuery -->
<script type="text/javascript"
	src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<!-- iamport.payment.js -->
<script type="text/javascript"
	src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<script>
	var IMP = window.IMP;
	IMP.init("imp12332144");

	// 함수를 수정하여 각 상품의 가격과 수량을 기반으로 총 금액을 계산
	function calculateTotalAmount() {
		var totalAmount = 0;
		var inputElements = document
				.querySelectorAll('input[type="number"][name^="quantity_"]');

		inputElements.forEach(function(inputElement) {
			var quantity = parseInt(inputElement.value);
			var price = parseInt(inputElement.getAttribute('data-price'));
			totalAmount += quantity * price;
		});

		var totalAmountElement = document.getElementById('totalAmount');
		if (totalAmountElement) {
			totalAmountElement.textContent = totalAmount;
		}

		return totalAmount;
	}

	$(document).ready(
			function() {
				calculateTotalAmount();
				$('input[type="number"][name^="quantity_"]').change(
						calculateTotalAmount);
			});

	function requestPay(event) {
		event.preventDefault();
		var totalAmount = calculateTotalAmount(); // 총액 계산

		var buyerEmail = document.getElementById('memberEmail').textContent;
		var buyerName = document.getElementById('memberName').textContent;
		var buyerTel = document.getElementById('memberPhone').textContent;
		var buyerAddr = document.getElementById('memberAddress').textContent
				+ ' '
				+ document.getElementById('memberDetailedAddress').textContent;
		var buyerPostcode = document.getElementById('memberZipNum').textContent;

		var firstProductName = document.getElementById('firstProductName').textContent;
		var totalProductCount = parseInt(document
				.getElementById('totalProductCount').textContent, 10);

		var orderName = totalProductCount > 1 ? firstProductName + ' 외 '
				+ (totalProductCount - 1) + '건' : firstProductName;

		IMP.request_pay({
			pg : '9810030929',
			pay_method : 'card',
			merchant_uid : new Date().getTime(), // 상점에서 생성한 고유 주문번호
			name : '주문명: ' + orderName,
			amount : totalAmount, // 계산된 총 금액 사용
			buyer_email : buyerEmail,
			buyer_name : buyerName,
			buyer_tel : buyerTel,
			buyer_addr : buyerAddr,
			buyer_postcode : buyerPostcode,
			m_redirect_url : '{결제 완료 후 리디렉션 될 URL}'
		}, function(rsp) { // callback
			if (rsp.success) {
				var form = document.getElementById("orderForm");
				form.submit();
			} else {
				console.log(rsp);
			}
		});
	}
	$(document).ready(function() {
		calculateTotalAmount();
	});
</script>
</head>
<body>

	<header th:include="header :: body"></header>
	<h1>Basket List</h1>
	<div
		th:if="${basket == null || basket.products == null || basket.products.isEmpty()}">
		<p>장바구니에 제품이 없습니다.</p>
	</div>


	<div
		th:if="${basket != null && basket.products != null && !basket.products.isEmpty()}">
		<form id="orderForm" th:action="@{/basketOrder}" method="post"
			onsubmit="requestPay(event)">
			<table>
				<thead>
					<tr>
						<th>Product Name</th>
						<th>Quantity</th>
						<th>Price</th>
					</tr>
				</thead>
				<tbody>
					<!-- Iterate through the products in the basket -->
					<th:block th:each="product : ${basket.products}">
						<tr>
							<td th:text="${product.productName}"></td>
							<td>
								<!-- 수량 입력 필드 with onchange event --> <input type="number"
								th:name="'quantity_' + ${product.productNo}"
								th:value="${basket.productQuantityMap[product.productNo]}"
								min="1" onchange="calculateTotalAmount()"
								th:data-price="${product.price}" />
							</td>
							<td th:text="${product.price}"></td>
						</tr>
					</th:block>
				</tbody>
				<tfoot>
					<tr>
						<td colspan="3">Total Amount: <span id="totalAmount">0</span></td>
					</tr>
				</tfoot>
			</table>
			<!-- '주문하기' 버튼은 basket.products가 비어있지 않은 경우에만 표시됨 -->
			<input type="hidden" name="basketId" th:value="${basket.basketId}" />
			<button type="submit">주문하기</button>
		</form>
	</div>
	<!-- '쇼핑하기' 버튼 추가, item/all 로 이동 -->
	<div class="shopping-button">
		<a th:href="@{/item/all}"><button>쇼핑하기</button></a>
	</div>

	<span id="memberEmail" style="display: none;" th:text="${member.email}"></span>
	<span id="memberName" style="display: none;" th:text="${member.name}"></span>
	<span id="memberPhone" style="display: none;"
		th:text="${member.phoneNumber}"></span>
	<span id="memberAddress" style="display: none;"
		th:text="${member.address}"></span>
	<span id="memberDetailedAddress" style="display: none;"
		th:text="${member.detailedAddress}"></span>
	<span id="memberZipNum" style="display: none;"
		th:text="${member.zipNum}"></span>
	<span id="firstProductName" style="display: none;"
    th:if="${not #lists.isEmpty(basket.products)}"
    th:text="${basket.products[0].productName}"></span>
	<span id="totalProductCount" style="display: none;"
		th:text="${#lists.size(basket.products)}"></span>

</body>
</html>
